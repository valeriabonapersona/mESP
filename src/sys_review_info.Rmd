---
title: 'mESP'
output: word_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
source("config/utilities.R")
source("src/general_funs.R")
library(knitr) # for tables
library(metaforest) # for exploratory analysis
library(caret) # for exploratory analysis
options(scipen=1, digits=3)
```

# Results

```{r load data, include=FALSE}
dat <- readRDS(paste0(final, "data_for_analysis.RDS"))

id_both_sex <- dat %>% 
  group_by(id, sex) %>% 
  count() %>%
  pivot_wider(names_from = "sex", values_from = "n") %>% 
  na.omit()

# for freq females
freq_fem <- dat %>% 
  filter(sex == "female", 
         ba_grouped == "hippocampus") %>% 
  mutate(out_grouped = ifelse(
    str_detect(out_grouped, "dendrites|complexity"), 
    "dendritic_changes", out_grouped)) %>%
  group_by(out_grouped) %>% 
  summarize(
    across(ends_with("id"), function(x) round(length(unique(x)),2)), 
    .groups = "drop"
  )

neuro_outcomes <- c("brdu_cells", "dcx", "ki67")
morph_outcomes <- c("size", "branching_dendrites", "length_dendrites")
```
## Study selection and characteristics
An overview of the study design is summarized in the flow chart (Fig. 1 - *still to do*). Our pre-specified inclusion criteria (**Methods**) were met by `r n_distinct(dat$id)` publications, published between `r str_remove_all(dat$cite, ".*\\(") %>% str_remove_all("\\)") %>% as.numeric() %>% min()` and `r str_remove_all(dat$cite, ".*\\(") %>% str_remove_all("\\)") %>% as.numeric() %>% max()`. The included publications contributed `r n_distinct(dat$exp_id)` unique experiments for a total of `r nrow(dat)` comparisons, from which we extracted statistical measuments (e.g. mean, standard deviation (SD) and sample size (N)). X publications (ref) were excluded from the analysis as it was not possible to extract nor infer any statistical measurement. Similarly, information was lacking from X comparisons of X other publications. 

The included publications mainly used rats (n~publ~ = `r length(unique(dat[dat$species == "rat",]$id))/length(unique(dat$id))*100`%) and the maternal separation ELA model (n~publ~ = `r length(unique(dat[dat$model == "maternal_separation",]$id))/length(unique(dat$id))*100`%), followed by limited nesting and bedding (n~publ~ = `r length(unique(dat[dat$model == "limited_nesting",]$id))/length(unique(dat$id))*100`%), maternal deprivation (n~publ~ = `r length(unique(dat[dat$model == "maternal_deprivation",]$id))/length(unique(dat$id))*100`%), licking and grooming (n~publ~ = `r length(unique(dat[dat$model == "licking_grooming",]$id))/length(unique(dat$id))*100`%) and isolation (n~publ~ = `r length(unique(dat[dat$model == "isolation",]$id))/length(unique(dat$id))*100`%). 

A total of ~`r sum(c(dat$n_e, dat$n_c))` animals were used, `r sum(c(dat[dat$sex == "male",]$n_e, dat[dat$sex == "male",]$n_c)) / sum(c(dat$n_e, dat$n_c)) * 100`% of which were males. `r n_distinct(id_both_sex$id)` publications performed experiments in both male and female rodents. Similarly to previous studies, we aimed to analyze males and females separately, as two different biological systems, since sex-dismorphic characteristics have been frequently observed in stress research. However, data on females was too scarse to be meta-anlyzed, with an average across outcomes of `r mean(freq_fem$unique_id)`±`r sd(freq_fem$unique_id)` comparisons from `r mean(freq_fem$id)`±`r sd(freq_fem$id)` publications. We therefore focused our quantitative analysis on males. 

To study structural plasticity, we focused on morphology (i.e., changes in the size of brain areas, morphology of dendrites and spine density), neurogenesis (i.e., brdu, dcx and ki67) and BDNF *Table 1* summarises the frequency of each outcome. 

```{r freq outcomes, echo=FALSE, results='asis'}

freq_out <- dat %>% 
  mutate(
    out_grouped = ifelse(str_detect(out_grouped, "dendrites|complexity"), "dendritic_changes", out_grouped), 
    functional_interpretation = case_when(
      out_grouped %in% c("size", "spines", "dendritic_changes") ~ "morphology",
      out_grouped == "bdnf" ~ "bdnf",
      T ~ "neurogenesis")) %>%
  group_by(functional_interpretation, out_grouped) %>% 
  summarize(
    across(ends_with("id"), function(x) length(unique(x))), 
    .groups = "drop"
  ) %>% 
  arrange(-unique_id) %>% 
  rename(n_id = id, n_exp_id = exp_id, n_comp = unique_id, outcome = out_grouped) %>% 
  arrange(functional_interpretation)

kable(freq_out, caption = "Table 1. Outcome frequencies. The functional categorizations correspond to the classifications for the analyses.")

```

More than 10 brain areas have been investigated across publications. Since the hippocampus was the most predominant (`r nrow(dat[dat$ba_grouped == "hippocampus",])/nrow(dat) *100`% of comparisons, *Figure 2a*), we focused the quantitative synthesis on this brain area. *Figure 2b* summarizes the frequency of findings across brain areas, at a systematic review level.

Within the hippocampus, `r nrow(dat[dat$ba_main == "dentate_gyrus",])` comparisons were from the hippocampus, `r nrow(dat[dat$ba_main == "CA1",])` from the CA1, `r nrow(dat[dat$ba_main == "CA3",])` from the CA3, `r nrow(dat[dat$ba_main == "CA4",])` from the CA4, while `r nrow(dat[dat$ba_main == "hippocampus_total",])` measured the whole hippocampus. Since CA4


```{r freq ba, echo=FALSE}

freq_ba <- dat %>% 
  group_by(ba_grouped) %>% 
  summarize(
    across(ends_with("id"), function(x) length(unique(x))/nrow(.)*100), 
    .groups = "drop"
  )

g_freq_ba <- freq_ba %>% 
  arrange(unique_id) %>%
  mutate(
    ba_grouped = str_replace_all(ba_grouped, "_", " "),
    ba_grouped = factor(ba_grouped, ba_grouped)
    ) %>%
  ggplot(aes(ba_grouped,unique_id)) + 
  geom_segment(aes(x=ba_grouped ,xend=ba_grouped, 
                   y=0, yend=unique_id), color="grey") +
  geom_point(size = 2) +
  coord_flip() + 
  scale_y_continuous(breaks = c(0, 25, 50, 75), 
                     labels = c("0%", "25%", "50%", "75%")) + 
  labs(
    y = "% comparisons",
    x = "Brain areas", 
    caption = expression(italic("Figure 2a")~"Frequency across outcomes.")
  ) + 
  my_theme

g_sys_review_heat <- dat %>% 
  rowwise() %>%
  mutate(
    pval = t.test2(mean_c, mean_e, var_c, var_e, n_c, n_e), 
    sig = pval < 0.5
  ) %>% 
  group_by(
    out_grouped, ba_grouped, sex
  ) %>% 
  summarize(
    sig_obs = sum(sig),
    n_tot = length(unique_id), 
    sig_perc = sig_obs/n_tot * 100, 
    .groups = "drop"
  ) %>%
  
  # visualization
  ggplot(aes(str_replace_all(ba_grouped, "_", " "), str_replace_all(out_grouped, "_", " "), fill = sig_perc)) +
  geom_tile() + 
  geom_text(aes(label=n_tot)) +
  facet_wrap(~sex) + 
  coord_flip() + 
  labs(
    x = "Brain areas", 
    y = "Outcomes",
    caption = expression(italic("Figure 2b")~"Systematic review significance. At a systematic review level, we re-calculated pairwise comparisons based on the summary statistics extracted on the papers. Color intensity = proportion of significant comparisons. Numbers within each tile = number of comparisons."), 
    fill = "% significant comparisons"
  ) + 
  scale_fill_viridis() +
  my_theme + 
  theme(
    axis.text.x = element_text(angle=90, vjust = 0.5, hjust=1),
    legend.position = "bottom")

ggpubr::ggarrange(
  g_freq_ba, 
  g_sys_review_heat, 
  nrow = 2, heights = c(1,3)
)

```

## Main Analysis
```{r quant data}
# from dendrite morphology remove granule cells (only 3)
morph_granule_cells <- dat %>% 
  filter(out_grouped %in% c("branching_dendrites", "length_dendrites"), 
         ba_main == "dentate_gyrus") %>% 
  pull(unique_id)

hip_full <- dat %>% 
  filter(
    sex == "male",
    ba_grouped == "hippocampus") %>% 
  
  # correct for mods analyses
  mutate(
    product_measured = case_when(
      out_grouped != "bdnf" ~ "not_applicable",
      product_measured %in% c("mrna", "rna") ~ "rna",
      T ~ product_measured
    ), 
    # at_death = case_when(
    #   out_grouped != "bdnf" ~ "not_applicable",
    #   T ~ at_death
    # ), 
    days_after_induction = case_when(
      out_grouped != "brdu_cells" ~ "not_applicable",
      days_after_induction <= 1 ~ "short", 
      days_after_induction > 1 ~ "long"
    )
  )

hip <- hip_full %>% 
  
  # select only data of interest
  filter(
    ba_main != "CA4",
    !out_grouped %in% c("complexity", "number_dendrites", "spines"), 
    !unique_id %in% morph_granule_cells
    )
```

Based on the frequencies reported above, we included in the quantitative synthesis only the outcomes in the hippocampus (CA4 excluded, n~publ~ = `r n_distinct(hip_full[hip_full$ba_main == "CA4",]$id)`), measured in male mice. Similarly, the number of dendrites (n~publ~ = `r n_distinct(hip_full[hip_full$out_grouped == "number_dendrites",]$id)`) and spine density (n~publ~ = `r n_distinct(hip_full[hip_full$out_grouped == "spines",]$id)`) were not included in the meta-analyses due to the limited number of publications. Table 2 summarizes their main results. Concerning the complexity outcome, except for `r n_distinct(hip_full[hip_full$out_grouped == "complexity",]$id)` publication, all the individual measures of this composite score were extracted and here analyzed separately. Ultimately, `r nrow(hip)` comparisons from `r n_distinct(hip$id)` distinct publications (n~exp~=`r n_distinct(hip$exp_id)`) were included in the quantitative analysis.

```{r table 2, echo=FALSE}
other_outcomes_table <- hip_full %>%
  
  # select only data of interest
  filter(
    ba_main != "CA4",
    out_grouped %in% c("number_dendrites", "spines"),
    !unique_id %in% morph_granule_cells
  ) %>%
  mutate(
    sig = case_when(
      ((abs(yi) - vi) > 0) & yi > 0 ~ "increase",
      ((abs(yi) - vi) > 0) & yi < 0 ~ "decrease",
      T ~ "not significant"
    )
  ) %>%
  arrange(out_grouped) %>%
  select(cite, link, model, origin, behavior, major_life_events,
         at_death, out_grouped, ba_main, product_measured, yi, vi, sig)

kable(other_outcomes_table, caption = "Table 2. Summary evidence on spine density and number of dendrites.")

```

Morphology, neurogenesis and bdnf were analysed in three distinct models. The 3-level mixed effect model by us used accounts for the dependency of multiple outcomes from the same papers. Since the covariances between the outcomes were not available from the individual studies, we could not account for the different correlations within the same model. In particular, we assume that the correlations within the morphology outcomes and within the neurogenesis outcomes are higher than between the two. The categorization of the different outcomes based on their functional interpretation was rather straightforward, as summarized in *Table 1*.

### Effects of early life adversity on morphology

```{r morphology models, include=FALSE}
morph_df <- hip %>% filter(out_grouped %in% morph_outcomes)

## final
mod_morph <- rma.mv(
  yi, vi, 
  random = ~ 1|id,
  method = "REML",
  data = hip %>% filter(out_grouped  %in% c("size", "branching_dendrites", "length_dendrites")),
  mods = ~ out_grouped:ba_main:trauma_presence - 1,
  slab = exp_id
)

# calculate I2
W <- diag(1/hip[hip$out_grouped %in% c("size", "branching_dendrites", "length_dendrites"),]$vi)
X <- model.matrix(mod_morph)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
I2_morph <- 100 * sum(mod_morph$sigma2) / (sum(mod_morph$sigma2) + (mod_morph$k-mod_morph$p)/sum(diag(P)))

# between and within cluster heterogeneity
#100 * mod_morph$sigma2 / (sum(mod_morph$sigma2) + (mod_morph$k-mod_morph$p)/sum(diag(P)))

```

A 3-level model was used to investigate whether ELA significantly impacted structural plasticity in adulthood. In particular, we analyzed whether the effects differed across outcomes (volume of the brain area, number of dendritic branches and length of dendrites) and whether other traumatic life experiences interacted with the effects. Of note, the groups compared always differed only in the experience (or not) of early life adversity. Therefore effects of other traumatic life events should be considered as "enhancing" (or not) the effects of early life adversity. We performed subgroup analysis to analyze whether the effects differ across sub-parts of the hippocampus. In our 3-level model, these moderators cumulatively explained a significant portion of the variance (Q~m~(`r mod_morph$QMdf[1]`)=`r mod_morph$QM`, *p*=`r mod_morph$QMp`). The remaining heterogeneity was not significant (Q~h~(25)=`r mod_morph$QE`, *p*=`r mod_morph$QEp`, I^2^ = `r I2_morph`), thereby suggesting that no other moderators are necessary to explain the effects of ELA on morphology.


```{r morphology tests, include=FALSE}
interactions <- names(data.frame(mod_morph$X))

# contrasts organized in table
other <- c("dentate_gyrus", "CA1", "CA3", "trauma_presenceyes")

morph_contr <-   cbind(
    sapply(morph_outcomes, function(x) 
      ifelse(str_detect(interactions,x),
             1/sum(str_detect(interactions,x)),
             0
             )
      ) %>% data.frame(),

    sapply(other, function(x) 
      
      ifelse(str_detect(interactions,x),
             1/sum(str_detect(interactions,x)),
             -1/(length(interactions)-sum(str_detect(interactions,x)))
             )
    )
)


morph_contr <- morph_contr %>% t() %>% as.matrix()

morph_res <- summary(multcomp::glht(mod_morph, linfct = morph_contr, df=df.residual(mod_morph)), test=multcomp::adjusted('holm'))

```

Overall, early life adversity significantly reduced the size of the hippocampus (*g*(se) = `r morph_res$test$coefficients["size"]`(`r morph_res$test$sigma["size"]`), t = `r morph_res$test$tstat["size"]`, *p* = `r morph_res$test$pvalues["size"]`), decreased the number of branches per dendrites (*g*(se) = `r morph_res$test$coefficients["branching_dendrites"]`(`r morph_res$test$sigma["branching_dendrites"]`), t = `r morph_res$test$tstat["branching_dendrites"]`, *p* = `r morph_res$test$pvalues["branching_dendrites"]`), and decreased the total dendritic length (*g*(se) = `r morph_res$test$coefficients["length_dendrites"]`(`r morph_res$test$sigma["length_dendrites"]`), t = `r morph_res$test$tstat["length_dendrites"]`, *p* = `r morph_res$test$pvalues["length_dendrites"]`). All sub-parts of the hippocampus were equally affected (Table 3), although specific interactions with traumatic events were not possible due to the lack of outcomes. 

```{r table 3}
res_morph_ba <- data.frame(
  comparison = c("dentate vs CA1 + CA3", "CA1 vs dentate + CA3", "CA3 vs dentate + CA1"),
  g = morph_res$test$coefficients[c("dentate_gyrus", "CA1", "CA3")], 
  se = morph_res$test$sigma[c("dentate_gyrus", "CA1", "CA3")], 
  t = morph_res$test$tstat[c("dentate_gyrus", "CA1", "CA3")], 
  `p adj` = morph_res$test$pvalues[c("dentate_gyrus", "CA1", "CA3")]
)
rownames(res_morph_ba) <- NULL

kable(res_morph_ba, caption = "Table 3. No differences across hippocampal sub-brain areas.")

```

The experience of other traumatic events nullified the effects of early life adversity (*g*(se) = `r morph_res$test$coefficients["trauma_presenceyes"]`(`r morph_res$test$sigma["trauma_presenceyes"]`), t = `r morph_res$test$tstat["trauma_presenceyes"]`, *p* = `r morph_res$test$pvalues["trauma_presenceyes"]`). Qualitatively, this was consistent across all outcomes. 


```{r morphology results barplot, fig.width=10, fig.height=8}
## baseline & acute stress
df_g_morph <- data.frame(
  g = mod_morph$beta, 
  sem = mod_morph$se,
  pval = mod_morph$pval
) %>% 
  mutate(
    out_grouped = str_remove_all(rownames(.), "out_grouped") %>% str_remove_all("\\:.*"),
    ba_main = str_remove_all(rownames(.), ".*ba_main") %>% str_remove_all("\\:.*"),
    trauma_presence = str_remove_all(rownames(.), ".*trauma_presence")
  )

g_morphology <- df_g_morph %>%
  ggplot(aes(trauma_presence, g, fill = trauma_presence)) + 
  geom_bar(stat = "identity", colour = "black") + 
  geom_errorbar(aes(ymin = g-sem, ymax = g+sem), width = 0.2) +
  
  # beautiful
 # ylim(c(-0.2,0.8)) + 
  my_theme + 
  labs(x="", y = "Hedge's g", 
      caption = expression(italic("Figure 3")~"Effects of ELA on morphology.")
) + 
  facet_grid(str_replace_all(out_grouped, "_", " ")~str_replace_all(ba_main, "_", " ")) + 
  scale_fill_manual(values = c("white", "grey")) + 
  # geom_text(x = "Baseline", y = max(df_fig_main$g) + 0.2, label = "*", size = 20) + 
  # geom_text(aes(y = 0.05, label = paste("n = ", n), size = 20)) + 
  theme(text = element_text(size = 20), 
        axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5), 
        legend.position = "none")

g_morphology
```


### Effects of early life adversity on neurogenesis
#### For Marian: Considerations about publications
4 papers mentioned only "subventricular zone" and not "dentate gyrus" (Pubmed id = = 29563870, 20816703, 20816703, 25288769, 23237316), and divide between ventral and dorsal. I have included these papers as dentate gyrus. For one paper (Suppl. Figure S8 in pubmedid = 25288769), I am not sure whether it can indeed be considered dentate gyrus. 

One paper (Pubmed id = `r hip %>% filter(out_grouped %in% c("brdu_cells", "dcx", "ki67"), ba_main != "dentate_gyrus") %>% pull(id) %>% unique()`) specifies "whole hippocampus". I have excluded this paper for now. 


There is a paper from Naninck 2015 (https://doi.org/10.1002/hipo.22374
), where there is a positive effect of ELA on ki67; however, they could not replicate it even in the same publication. From influential analysis, it seems that this paper is really "out" compared to the others when it comes to explaining heterogeneity. 

#### Neurogenesis results

```{r neurogenesis models, include=FALSE}
neuro_df <- hip %>% 
  filter(
    out_grouped %in% neuro_outcomes, 
    ba_main == "dentate_gyrus", 
    id != "27644094", 
    ) %>% 
  mutate(
    out_grouped = paste(out_grouped, days_after_induction, sep = "_") %>% str_remove_all("_not_applicable"), 
    at_death = ifelse(at_death == "rest", "rest", "not_rest")
  )

mod_neuro <- rma.mv(
  yi, vi, 
  random = ~ 1|id,
  method = "REML",
  data = neuro_df,
  mods = ~ out_grouped:trauma_presence - 1,
  slab = exp_id
)

# calculate I2
W <- diag(1/neuro_df$vi)
X <- model.matrix(mod_neuro)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
I2_neuro <- 100 * sum(mod_neuro$sigma2) / (sum(mod_neuro$sigma2) + (mod_neuro$k-mod_neuro$p)/sum(diag(P))) 

# between and within cluster heterogeneity
#100 * mod_morph$sigma2 / (sum(mod_morph$sigma2) + (mod_morph$k-mod$p)/sum(diag(P)))

```

The effects of ELA on neurogenesis were investigated in terms of proliferation, differentiation, and survival by investigating the differences in expression levels of ki67, dcx and brdu after short (<1  day, interpreted as proliferation) and long (> 1 day, interpreted as survival) induction time. Furthermore, we investigated whether the experience of other traumatic life events interacted with these outcomes. We focused on the dentate gyrus, and we therefore excluded 1 publication which analysed the whole hippocampus (Pubmed id = `r hip %>% filter(out_grouped %in% c("brdu_cells", "dcx", "ki67"), ba_main != "dentate_gyrus") %>% pull(id) %>% unique()`). Additionally, one publication (PMID = "27644094") was removed from the analysis because both its comparisons were evaluated as potential outliers and majorly impacted the results after by sensitivity analysis.

In our 3-level model, the moderators explained a significant portion of the variance (Q~m~(`r mod_neuro$QMdf[1]`)=`r mod_neuro$QM`, *p*=`r mod_neuro$QMp`). However, there were still unexplained heterogeneity in the model (Q~h~(27)=`r mod_neuro$QE`, *p*=`r mod_neuro$QEp`), suggesting that additional moderators may be relevant to explain the effects. This will be later assessed with the exploratory moderator analysis. 


```{r neurogenesis tests, include=FALSE}
interactions <- names(data.frame(mod_neuro$X))

# contrasts organized in table

neuro_contr <-   cbind(
    sapply(c(neuro_outcomes[-1], "short", "long"), function(x) 
      ifelse(str_detect(interactions,x),
             1/sum(str_detect(interactions,x)),
             0
             )
      ),
    
      sapply("trauma_presenceyes", function(x) 
        ifelse(str_detect(interactions,x),
               1/sum(str_detect(interactions,x)),
               -1/(length(interactions)-sum(str_detect(interactions,x)))
               )
    )
    
)


neuro_contr <- neuro_contr %>% t() %>% as.matrix()

neuro_res <- summary(multcomp::glht(mod_neuro, linfct = neuro_contr, df=df.residual(mod_neuro)), test=multcomp::adjusted('holm'))

```

Early life adversity decreased the expression of dcx (*g*(se) = `r neuro_res$test$coefficients["dcx"]`(`r neuro_res$test$sigma["dcx"]`), t = `r neuro_res$test$tstat["dcx"]`, *p* = `r neuro_res$test$pvalues["dcx"]`), and brdu both with short (*g*(se) = `r neuro_res$test$coefficients["short"]`(`r neuro_res$test$sigma["short"]`), t = `r neuro_res$test$tstat["short"]`, *p* = `r neuro_res$test$pvalues["short"]`) and long (*g*(se) = `r neuro_res$test$coefficients["long"]`(`r neuro_res$test$sigma["long"]`), t = `r neuro_res$test$tstat["long"]`, *p* = `r neuro_res$test$pvalues["long"]`) time since induction. Conversely, ki67 expression was uneffected (*g*(se) = `r neuro_res$test$coefficients["ki67"]`(`r neuro_res$test$sigma["ki67"]`), t = `r neuro_res$test$tstat["ki67"]`, *p* = `r neuro_res$test$pvalues["ki67"]`). Overall the results were comparable both for groups that experienced and not other traumatic life events (*g*(se) = `r neuro_res$test$coefficients["trauma_presenceyes"]`(`r neuro_res$test$sigma["trauma_presenceyes"]`), t = `r neuro_res$test$tstat["trauma_presenceyes"]`, *p* = `r neuro_res$test$pvalues["trauma_presenceyes"]`). All results are shown in Figure 4 (for the paper I will show only the results on the significant analyses).



```{r neurogenesis results barplot, fig.width=10, fig.height=8}
df_g_neuro <- data.frame(
  g = mod_neuro$beta, 
  sem = mod_neuro$se,
  pval = mod_neuro$pval
) %>% 
  mutate(
    out_grouped = str_remove_all(rownames(.), "out_grouped") %>% str_remove_all("\\:.*"),
    trauma_presence = str_remove_all(rownames(.), ".*trauma_presence") %>% str_remove_all("\\:.*")
  )

g_neuro <- df_g_neuro %>%
  ggplot(aes(trauma_presence, g, fill = trauma_presence)) + 
  geom_bar(stat = "identity", colour = "black") + 
  geom_errorbar(aes(ymin = g-sem, ymax = g+sem), width = 0.2) +
  
  # beautiful
 # ylim(c(-0.2,0.8)) + 
  my_theme + 
  labs(x="", 
       y = "Hedge's g",
       caption = expression(italic("Figure 4")~"Effects of ELA on neurogenesis.")
    ) + 
  facet_grid(~str_replace_all(out_grouped, "_", " ")) + 
  scale_fill_manual(values = c("white", "grey")) + 
  # geom_text(x = "Baseline", y = max(df_fig_main$g) + 0.2, label = "*", size = 20) + 
  # geom_text(aes(y = 0.05, label = paste("n = ", n), size = 20)) + 
  theme(text = element_text(size = 20), 
        axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5), 
        legend.position = "none")

g_neuro
```

**Note about discrepancy brdu short and ki67:** ki67 is *the* proliferating marker, because it tags G1, S, G2 and M phases of the cell cycle. Conversely, brdu is visible only during DNA synthesis (S phase). I wondered whether it had something to do with the state of the animal at death. I merged together "aroused" and "stressed" into one category. The graph below distinguishes between these. To me it seems that the apparent difference between brdu short and ki67 may be due to the state of the animal at induction. Of course, this is subgroup exploratory analysis, so the results should be interpreted with caution.

```{r subgroup expl analysis}
neuro_df_subgroup <- neuro_df %>% 
  filter(out_grouped %in% c("brdu_cells_short", "ki67"))

# for visualization. For actual subgroup analysis, check https://www.metafor-project.org/doku.php/tips:comp_two_independent_estimates
res1 <- rma.mv(
  yi, vi, 
  random = ~ 1|id,
  method = "REML",
  data = neuro_df_subgroup,
  mods = ~ out_grouped:trauma_presence:at_death - 1,
  slab = exp_id
)


df_g_neuro_sub <- data.frame(
  g = res1$beta, 
  sem = res1$se,
  pval = res1$pval
) %>% 
  mutate(
    out_grouped = str_remove_all(rownames(.), "out_grouped") %>% str_remove_all("\\:.*"),
    trauma_presence = str_remove_all(rownames(.), ".*trauma_presence") %>% str_remove_all("\\:.*"), 
    at_death = str_remove_all(rownames(.), ".*at_death")
  )

g_neuro_sub <- df_g_neuro_sub %>%
  ggplot(aes(trauma_presence, g, fill = trauma_presence)) + 
  geom_bar(stat = "identity", colour = "black") + 
  geom_errorbar(aes(ymin = g-sem, ymax = g+sem), width = 0.2) +
  
  # beautiful
 # ylim(c(-0.2,0.8)) + 
  my_theme + 
  labs(x="", 
       y = "Hedge's g",
       caption = expression(italic("Figure 4")~"Effects of ELA on neurogenesis.")
    ) + 
  facet_grid(str_replace_all(at_death, "_", " ")~str_replace_all(out_grouped, "_", " ")) + 
  scale_fill_manual(values = c("white", "grey")) + 
  # geom_text(x = "Baseline", y = max(df_fig_main$g) + 0.2, label = "*", size = 20) + 
  # geom_text(aes(y = 0.05, label = paste("n = ", n), size = 20)) + 
  theme(text = element_text(size = 20), 
        axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5), 
        legend.position = "none")

g_neuro_sub
```


```{r influence analysis, eval=FALSE, include=FALSE}
mod_infl <- rma(
  yi, vi, 
  method = "REML",
  data = hip,
  mods = ~ out_grouped:trauma_presence:days_after_induction - 1,
  slab = exp_id
)
sav <- baujat(mod_infl, symbol=19, xlim=c(0,5))
sav <- sav[sav$x >= 1 | sav$y >= 1,]
text(sav$x, sav$y, sav$slab, pos=1)

```


### Analysis of bdnf

```{r bdnf data}
bdnf_df <- hip %>% 
  filter(out_grouped == "bdnf")

bdnf_out_summ <- bdnf_df %>% 
  group_by(ba_main) %>% 
  summarize(
    n_comp = length(ba_main), 
    per = (n_comp / nrow(.)) * 100
  )

bdnf_ba_mod <- rma.mv(yi, vi, 
  random = ~ 1|id,
  method = "REML",
  data = hip %>% filter(out_grouped == "bdnf"),
  mods = ~ ba_main - 1,
  slab = exp_id
  )
```

Potential moderators of ELA on BDNF expression were the type of outcome investigated (RNA or protein), the (sub) the experience of other stressful life experiences, and the state of the animals at death (rest or aroused/stressed). The latter is relevant only for RNA outcomes because for most studies there was a short interval between the induction of the arousal/stress state and the decapitation. Sub-parts of the hippocampus was not included in the final model because it did not explain a significant portion of the variance in the univariate model (Q~m~(`r bdnf_ba_mod$QMdf[1]`)=`r bdnf_ba_mod$QM`, *p*=`r bdnf_ba_mod$QMp`).Furthermore, sub-brain areas are unlikely to interact with other moderators because the majority of observations were measured in the whole hippocampus (`r bdnf_out_summ[bdnf_out_summ$ba_main == "hippocampus_total",]$per`% of bdnf comparisons).

```{r bdnf model, include=FALSE}

bdnf_df <- bdnf_df %>% 
  mutate(at_death = ifelse(at_death == "rest", "rest", "not_rest"))

mod_bdnf <- rma.mv(
  yi, vi, 
  random = ~ 1|id,
  method = "REML",
  data = bdnf_df,
  mods = ~ trauma_presence:product_measured:at_death - 1,
  slab = exp_id
)


# calculate I2
W <- diag(1/hip[hip$out_grouped == "bdnf",]$vi)
X <- model.matrix(mod_bdnf)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
I2_bdnf <- 100 * sum(mod_bdnf$sigma2) / (sum(mod_bdnf$sigma2) + 
                                           (mod_bdnf$k-mod_bdnf$p)/sum(diag(P))) 

# between and within cluster heterogeneity
#100 * mod_morph$sigma2 / (sum(mod_morph$sigma2) + (mod_morph$k-mod$p)/sum(diag(P)))

```

In our 3-level model, the presence of other traumatic life experiences, the state of the animal at death and the type of product investigated cumulatively explained a significant portion of the variance (Q~m~(`r mod_bdnf$QMdf[1]`)=`r mod_bdnf$QM`, *p*=`r mod_bdnf$QMp`). The remaining heterogeneity was still high (Q~h~(25)=`r mod_bdnf$QE`, *p*=`r mod_bdnf$QEp`, I^2^ = `r I2_bdnf`) and was further explored with metaforest analysis. 

```{r bdnf tests, include=FALSE}
interactions <- names(data.frame(mod_bdnf$X))

# contrasts organized in table

bdnf_contr <-   cbind(
  
  # protein vs 0, rna vs 0
    sapply(c("protein", "rna"), function(x) 
      ifelse(str_detect(interactions,x),
             1/sum(str_detect(interactions,x)),
             0
             )
      ),
    
  # not rest vs 
        sapply(c("not_rest"), function(x)
      ifelse(str_detect(interactions, "protein"), 0,
        ifelse(str_detect(interactions, x),
               1/sum(str_detect(interactions,x)), 
               -1/(length(interactions)-
                     sum(str_detect(interactions[!str_detect(interactions,"proteins")],x)))
               ))
    ),
  sapply("trauma_presenceyes", function(x) 
        ifelse(str_detect(interactions,x),
               1/sum(str_detect(interactions,x)),
               -1/(length(interactions)-sum(str_detect(interactions,x)))
               )
    ),
    sapply(c("at_deathnot_rest", "at_deathrest"), function(x)
      ifelse(str_detect(interactions, "protein"), 0,
        ifelse(str_detect(interactions, x),
              1/sum(str_detect(interactions[!str_detect(interactions,"protein")],x)), 0)))
)


bdnf_contr <-bdnf_contr %>% t() %>% as.matrix()

bdnf_res <- summary(multcomp::glht(mod_bdnf, linfct = bdnf_contr, df=df.residual(mod_bdnf)), test=multcomp::adjusted('holm'))

bdnf_trauma_mod <- rma.mv(
  abs(yi), vi, 
  random = ~ 1|id,
  method = "REML",
  data = bdnf_df,
  mods = ~ trauma_presence:product_measured:at_death - 1,
  slab = exp_id
)
bdnf_trauma_contr <- rep(c(0.25, -0.25),4)
bdnf_trauma_res <- anova(bdnf_trauma_mod, L=bdnf_trauma_contr)
```

Early life adversity did not alter bdnf when measured as protein (*g*(se) = `r bdnf_res$test$coefficients["protein"]`(`r bdnf_res$test$sigma["protein"]`), t = `r bdnf_res$test$tstat["protein"]`, *p* = `r bdnf_res$test$pvalues["protein"]`). However, bdnf RNA was significantly decreased at rest (*g*(se) = `r bdnf_res$test$coefficients["at_deathrest"]`(`r bdnf_res$test$sigma["at_deathrest"]`), t = `r bdnf_res$test$tstat["at_deathrest"]`, *p* = `r bdnf_res$test$pvalues["at_deathrest"]`) and significantly increased when the animal was sacrifised in aroused or stress circumstances (*g*(se) = `r bdnf_res$test$coefficients["at_deathnot_rest"]`(`r bdnf_res$test$sigma["at_deathnot_rest"]`), t = `r bdnf_res$test$tstat["at_deathnot_rest"]`, *p* = `r bdnf_res$test$pvalues["at_deathnot_rest"]`). From qualitative evaluation, bdnf outcomes had consistently a smaller effect size in animals that experienced other traumatic life experiences; however, the interaction was not significant (*g*(se) = `r bdnf_trauma_res$Xb`(`r bdnf_trauma_res$se`), z = `r bdnf_trauma_res$zval`, *p* = `r bdnf_trauma_res$pval`). Figure 5 summarizes the overall results (not yet those reported specifically by the analysis).


```{r bdnf results barplot, fig.width=10, fig.height=8}
## baseline & acute stress
df_g_bdnf <- data.frame(
  g = mod_bdnf$beta, 
  sem = mod_bdnf$se,
  pval = mod_bdnf$pval
) %>% 
  mutate(
    trauma_presence = str_remove_all(rownames(.), "trauma_presence") %>% str_remove_all("\\:.*"),
    
    product_measured = str_remove_all(rownames(.), ".*product_measured") %>% str_remove_all("\\:.*"),
    at_death = str_remove_all(rownames(.), ".*at_death")
  )

g_bdnf <- df_g_bdnf %>%
  ggplot(aes(trauma_presence, g, fill = trauma_presence)) + 
  geom_bar(stat = "identity", colour = "black") + 
  geom_errorbar(aes(ymin = g-sem, ymax = g+sem), width = 0.2) +
  
  # beautiful
 # ylim(c(-0.2,0.8)) + 
  my_theme + 
  labs(x="", 
       y = "Hedge's g",
       caption = expression(italic("Figure 5")~"Effects of ELA on bdnf expression.")
    ) + 
  facet_grid(at_death~str_replace_all(product_measured, "_", " ")) + 
  scale_fill_manual(values = c("white", "grey")) + 
  # geom_text(x = "Baseline", y = max(df_fig_main$g) + 0.2, label = "*", size = 20) + 
  # geom_text(aes(y = 0.05, label = paste("n = ", n), size = 20)) + 
  theme(text = element_text(size = 20), 
        axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5), 
        legend.position = "none")

g_bdnf
```


## Exploratory analysis with metaforest
The models on neurogenesis and bdnf had remaining unexplained variance. To explore potential moderators, we used metaforest, an application of random forests to meta-analysis data by means of bootstrap sampling. After a thresholded preselection, metaforest ranks moderators based on their influence on effect size. 

### Exploratory analysis neurogenesis

```{r metaforest neurogenesis, include=FALSE}
vars_metaforest <- c("id", "yi", "vi", 
                     "species", "age_testing_weeks", "model",
                     "origin", "housing_after_weaning", "behavior",
                     "major_life_events", "at_death", "ba_main"
                     )
# Run model with many trees to check convergence
neuro <- neuro_df %>% 
  select(all_of(vars_metaforest), "days_after_induction")%>% 
  mutate(id = as.numeric(as.factor(id)))

# Convergence
# check_conv <- MetaForest(yi~.,
#                         data = neuro,
#                         study = "id",
#                         whichweights = "random",
#                         num.trees = 20000)
# plot(check_conv)

## model has converged in approx 5000 trees
# Model with 5000 trees for replication
mf_rep <- MetaForest(yi~.,
                        data = neuro,
                        study = "id",
                        whichweights = "random",
                        num.trees = 5000)
# Run recursive preselection, store results in object 'preselect'
preselected <- preselect(mf_rep,
                         replications = 100,
                         algorithm = "recursive")
# Plot the results
#plot(preselected)

# Retain only moderators with positive variable importance in more than
# 50% of replications
retain_mods <- preselect_vars(preselected, cutoff = 0.5)


# Set up 10-fold grouped (=clustered) CV
grouped_cv <- trainControl(method = "cv",
                           index = groupKFold(neuro$id, k = 10))

# Set up a tuning grid for the three tuning parameters of MetaForest
tuning_grid <- expand.grid(whichweights = c("random", "fixed", "unif"),
                       mtry = 2:6,
                       min.node.size = 2:6)

# X should contain only retained moderators, clustering variable, and vi
X <- neuro[, c("id", "vi", retain_mods)]

# Train the model
mf_cv <- train(y = neuro$yi,
               x = X,
               study = "id", # Name of the clustering variable
               method = ModelInfo_mf(),
               trControl = grouped_cv,
               tuneGrid = tuning_grid,
               num.trees = 5000)
# Examine optimal tuning parameters
rcv_neuro <- mf_cv$results[which.min(mf_cv$results$RMSE), ]


# For convenience, extract final model
final <- mf_cv$finalModel
# Extract R^2_{oob} from the final model
r2_oob_neuro <- final$forest$r.squared

# Plot variable importance
neuro_varimp <- VarImpPlot(final)

```

Of the investigated variables, only `r length(retain_mods)` were selected in more than 50% of the bootstraps, namely `r paste(retain_mods, collapse = ", ")`. Figure 6a shows the variable importance plot. Figure 6b shows the variable importance before variable selection. 

```{r neuro metaforest graphs, fig.width=10, fig.height=12}
ggpubr::ggarrange(
  neuro_varimp,
  plot(preselected), 
  labels = c("a", "b"),
  nrow = 2, heights = c(1,2)
)
```

To explore the source of unexplained heterogeneity in the neurogenesis model, we applied metaforest to our neurogenesis data. However, the portion of variance explained by metaforest was rather low (R~oob~^2^(MSE) = `r r2_oob_neuro`(`r final$forest$prediction.error`, R~cv~^2^(SD) = `r rcv_neuro$Rsquared`(`r rcv_neuro$RsquaredSD`))). This suggests that the unexplained heterogeneity in our model is unlikely explained with the currently known moderators. 


### Exploratory analysis bdnf

```{r metaforest bdnf, include=FALSE}

# Run model with many trees to check convergence
bdnf <- bdnf_df %>% 
  select(all_of(vars_metaforest), "product_measured")%>%
  mutate(id = as.numeric(as.factor(id)))

# checking convergence
# check_conv <- MetaForest(yi~.,
#                         data = bdnf,
#                      #   study = "id",
#                         whichweights = "random",
#                         num.trees = 20000)
# Plot convergence trajectory
#plot(check_conv)

## model has converged in approx 5000 trees
# Model with 5000 trees for replication
mf_rep <- MetaForest(yi~.,
                        data = bdnf,
                        study = "id",
                        whichweights = "random",
                        num.trees = 5000)

# Run recursive preselection, store results in object 'preselect'
preselected <- preselect(mf_rep,
                         replications = 100,
                         algorithm = "recursive")
# Plot the results
#plot(preselected)

# Retain only moderators with positive variable importance in more than
# 50% of replications
retain_mods <- preselect_vars(preselected, cutoff = .5)


# Set up 10-fold grouped (=clustered) CV
grouped_cv <- trainControl(method = "cv",
                           index = groupKFold(bdnf$id, k = 10))

# Set up a tuning grid for the three tuning parameters of MetaForest
tuning_grid <- expand.grid(whichweights = c("random", "fixed", "unif"),
                       mtry = 2:6,
                       min.node.size = 2:6)

# X should contain only retained moderators, clustering variable, and vi
X <- bdnf[, c("id", "vi", retain_mods)]

# Train the model
mf_cv <- train(y = bdnf$yi,
               x = X,
               study = "id", # Name of the clustering variable
               method = ModelInfo_mf(),
               trControl = grouped_cv,
               tuneGrid = tuning_grid,
               num.trees = 5000)

# Examine optimal tuning parameters
rcv_bdnf <- mf_cv$results[which.min(mf_cv$results$RMSE), ]

# For convenience, extract final model
final <- mf_cv$finalModel
# Extract R^2_{oob} from the final model
r2_oob_bdnf <- final$forest$r.squared
# Plot convergence
#plot(final)

# Plot variable importance
bdnf_varimp <- VarImpPlot(final)

# Sort the variable names by importance, so that the
# partial dependence plots will be ranked by importance
ordered_vars_bdnf <- names(final$forest$variable.importance)[
  order(final$forest$variable.importance, decreasing = TRUE)]

```


Among the defined potential moderators, metaforest ultimately selected `r length(ordered_vars_bdnf)` variables that explained a significant portion of the variance (r^2~oob~ = `r r2_oob_bdnf`, R~cv~^2^(SD) = `r rcv_bdnf$Rsquared`(`r rcv_bdnf$RsquaredSD`), Figure 7). Of these, 4 related to events that the animals experienced during their life.

```{r bdnf metafor graphs, echo=FALSE}
ggpubr::ggarrange(
  bdnf_varimp,
  plot(preselected), 
  labels = c("a", "b"),
  nrow = 2, heights = c(1,2)
)

# Plot partial dependence
# PartialDependence(final, vars = ordered_vars_bdnf,
#                   rawdata = TRUE, pi = .95)
```


## Comparing males and females

```{r sex}
sex <- dat %>% 
  
  # keep papers with both sexes
  filter(id %in% id_both_sex$id) %>% 
  
  # to wide format
  mutate(n_tot = n_c + n_e) %>%
  select(c(life_vars[c(1:3, 5:9)], 
           "out_grouped", "ba_grouped", "ba_main", "trauma_presence", "product_measured", "n_tot", "yi", "vi")) %>%
  pivot_wider(names_from = sex, values_from = c("n_tot", "yi", "vi")) %>% 
  
  # keep only exp with both sexes
  filter(!is.na(yi_male), !(is.na(yi_female))) 


```

Although female data cannot be meta-analyzed, we can calculate the difference in effect size between males and females for those experiments that have been conducted in both sexes (n~publ~ = `r n_distinct(sex$id)`, n~comp~ = `r nrow(sex)`). The obtained dataset contained comparisons from all outcomes and brain areas. Figure 8 visualizes the relationship between male and female data.

```{r sex graph, fig.width=10, fig.height=8}

g_sex <- sex %>% 
  
  ggplot(aes(abs(yi_female), abs(yi_male), color = out_grouped)) + 
  geom_abline(intercept = 0, slope = 1, size = 0.5, linetype = "dashed") +
  geom_point() + 
  xlim(c(-4,4)) + ylim(c(-4,4)) + 
  labs(
    x = "Effect size females",
    y = "Effect size males", 
    caption = expression(italic("Figure 8")~"Relationship between male and female effect sizes. Each dot corresponds to the effect size (g) difference between the same comparison measured in males and females within the same publication. The dotted line corresponds to the 45 degrees line where all dots should be if males and females were identical. Deviations from the line could be due to error or to real sex differences.")
  ) + 
  my_theme
  
g_sex
```


```{r sex diff}
# I can perform a wald type test (normally used for moderator analysis) to test for sex differences
# I will try to do it with the abs(yi), but it's still unclear to me what would happen to the meta-analysis

sex <- dat %>% 
  # remove 25288769 because not paired males females 
  filter(id != "25288769", 
         id %in% id_both_sex$id)

## perform two separate MA 
res1 <- rma(abs(yi), vi, data=sex, subset=sex=="male")
res2 <- rma.mv(abs(yi), vi, data=sex, subset=sex=="female")

# put in same df
dat.comp <- data.frame(
  estimate = c(coef(res1), coef(res2)), 
  stderror = c(res1$se, res2$se),
  meta = c("male","female"), 
  tau2 = round(c(res1$tau2, res2$tau2),3))

# fixed effect model to compare the two 
res_sex <- rma(estimate, sei=stderror, mods = ~ meta, method="FE", data=dat.comp, digits=3)
```

Wald test on this subset of the data did not identify any sex difference (z = `r res_sex$zval[2]`, p = `r res_sex$pval[2]`) in effect sizes, thereby suggesting that there is no overall difference between males and females on the effects of ELA on structural plasticity. Sex differences on specific outcomes and/or brain areas cannot however be excluded.
